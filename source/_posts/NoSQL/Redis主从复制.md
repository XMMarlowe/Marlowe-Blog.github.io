---
title: Redis主从复制
author: Marlowe
tags: Redis
categories: NoSQL
abbrlink: 53469
date: 2021-04-17 15:43:23
---
为了分担读压力，Redis支持主从复制，Redis的主从结构可以采用一主多从或者级联结构，Redis主从复制可以根据是否是全量分为全量同步和增量同步...
<!--more-->

### 概念
**主从复制：** 指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点（Master/Leader），后者称为从节点（Slave/Follower）， 数据的复制是单向的！只能由主节点复制到从节点（**主节点以写为主、从节点以读为主**）。

### 主从复制的作用
默认情况下，每台Redis服务器都是主节点，一个主节点可以有0个或者多个从节点，但每个从节点只能由一个主节点。

|作用|	解释|
|:----:|:----:|
|数据冗余|	主从复制实现了数据的热备份|
|故障恢复|	当主节点故障时，从节点可以暂时替代主节点提供服务式|
|负载均衡|	由主节点进行写操作，从节点进行读操作，分担服务器的负载；尤其是在多读少写的场景下，通过多个从节点分担负载，提高并发量|
|高可用基石|	主从复制还是哨兵和集群能够实施的基础|


### 全量复制与增量复制

#### 全量复制
* **Redis 全量复制一般发生在Slave初始化阶段，这时 Slave 需要将 Master 上的所有数据都复制一份。**
具体步骤如下：
1. 从服务器连接主服务器，发送SYNC命令；
2. 主服务器接收到sYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；
3. 主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
4. 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；
5. 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；
6. 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令。

![20210419161538](http://marlowe.oss-cn-beijing.aliyuncs.com/img/20210419161538.png)



#### 增量复制

* Redis 增量复制是指 Slave 初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。

* 增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。

### 为什么要搭建集群？
一般来说，要将Redis运用于工程项目中，只使用一台Redis是万万不能的（宕机），原因如下：
1. **从结构上**，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；
2. **从容量上**，单个Redis服务器内存容量有限，就算一台Redis服务器内存容量为256G，也不能将所有 内存用作Redis存储内存，一般来说，单台Redis大使用内存不应该超过20G。
### 复制原理

当启动一个 **slave node** 的时候，它会发送一个 **psync** 命令给 **master node**。
如果这是 slave node **初次**连接到 master node，那么会触发一次 **full resynchronization 全量复制**。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后， master 会将这个 RDB 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据；
如果slave node 跟 master node 有网络故障，断开了连接，会自动重连，**连接之后 master node 仅会复制给 slave 部分缺少的数据。**

### 过程原理
1. 当从库和主库建立MS关系后，**会向主数据库发送SYNC命令**

2. 主库接收到SYNC命令后会开始在**后台保存快照(RDB持久化过程)，** 并将期间接收到的 **写命令缓存起来**

3. 当快照完成后，**主Redis会将快照文件和所有缓存的写命令发送给从Redis**

4. **从Redis接收到后，会载入快照文件并且执行收到的缓存的命令**

5. 之后，**主Redis每当接收到写命令时就会将命令发送从Redis，从而保证数据的一致**

### 主从复制优缺点

#### 优点
* 支持主从复制，主机会自动将数据同步到从机，可以进行读写分离
* 为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成
* Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力。(层层连接)
* Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。
* Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，Redis则返回同步之前的数据

#### 缺点

* Redis不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的IP才能恢复。
* 主机宕机，宕机前有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性。
* Redis较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。



### 层层链路
上一个M链接下一个 S！
![20210419160917](http://marlowe.oss-cn-beijing.aliyuncs.com/img/20210419160917.png)

### 环境配置
只配置从库，不用配置主库!

```bash
127.0.0.1:6379> info replication   # 查看当前库的信息 # Replication 
role:master  # 角色  
master connected_slaves:0 #  没有从机
master_replid:b63c90e6c501143759cb0e7f450bd1eb0c70882a
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0 
second_repl_offset:-1
repl_backlog_active:0 
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0 
repl_backlog_histlen:0
```
复制3个配置文件，然后修改对应的信息
```bash
1端口
2pid 名字
3log文件名字
4dump.rdb 名字
```
修改完毕之后，启动我们的3个redis服务器，可以通过进程信息查看！
![20210419161107](http://marlowe.oss-cn-beijing.aliyuncs.com/img/20210419161107.png)

默认情况下，每台Redis服务器都是主节点；我们一般情况下只用配置从就好了！
认老大！ 一主 （79）二从（80，81）
![20210419161136](http://marlowe.oss-cn-beijing.aliyuncs.com/img/20210419161136.png)

真实的从主配置应该在配置文件中配置，这样的话是永久的，我们这里用的是命令，暂时的！
主机可以写，从机不能写只能读！主机中的所有信息和数据，都会自动从机保存！
![20210419161210](http://marlowe.oss-cn-beijing.aliyuncs.com/img/20210419161210.png)
测试：主机断开连接，从机依旧连接到主机的，但是没有写操作，这个候，主机如果回来了，从机依旧可以直接获取到主机写的信息！如果是使用命令行，来配置的主从，这个时候如果重启了，就会变回主机！只要变为从机，立马就会从 主机中获取值！

### 参考

[请你谈谈Redis主从复制的理解？](https://blog.csdn.net/zs18753479279/article/details/113913315)
