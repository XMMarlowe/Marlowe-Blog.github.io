---
title: Redis 持久化
author: Marlowe
tags: redis
categories: NoSQL
abbrlink: 15405
date: 2020-12-24 11:28:46
---
Redis是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失，所以Redis提供了持久化功能！
<!--more-->
### RDB(Redis DataBase)
**简介：**
在指定的时间间隔内将内存中的数据集写入磁盘，也就是行话讲的Snapshot快照，它恢复时时将快照文件直接读到内存里。Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模数据的恢复，且对数据恢复的完整性不是非常敏感，那么RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化的数据可能丢失。我们默认的就是RDB，一般情况下不需要修改这个配置！

在生产环境我们会将这个文件进行备份！

rdb保存的文件是dump.rdb  都是在配置文件中 快照中进行配置的！
**触发机制**
1. save的规则满足情况下，会自动触发rdb规则
2. 执行flushall命令，也会触发我们的rdb规则！
3. 退出redis，也会产生rdb文件
备份就自动生成一个dump.rdb

如何恢复rdb文件？
1. 只需将rdb文件放在redis启动目录就可以，redis启动的时候就会自动检查dump.rdb，并恢复其中的数据。
2. 查看需要存放的位置
```bash
127.0.0.1:6379> config get dir
1) "dir"
2) "D:\\Program Files\\redis-2.8.9"
```

优点：
1. 适合大规模的数据恢复！
2. 对数据的完整性要求不高

缺点：
1. 需要一定的时间间隔进行操作，如果redis意外宕机了，这个最后一次修改的数据就没有了！
2. fork进程的时候，会占用一定的内存空间！

### AOF(Append Only File)
**简介**
将我们的所有命令都记录下来，history，恢复的时候就把这个文件全部再执行一遍！
以日志的形式来记录每个读写操作，将Redis执行过的所有指令记录下来(读操作不记录),只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据,换言之，redis重启的话就根据日志文件的内容将写指令从前往后执行一次以完成数据的恢复工作
Aof保存的是appendonly.aof文件

默认是不开启的，需要手动进行配置，只需要将appendonly改为yes就可以开启aof！

重启redis就可以生效
如果这个aof文件有错，redis将无法启动，需要修复这个aof文件
redis提供了一个工具 `redis-check-aof --fix`
如果文件正常，重启就可以直接恢复了！

**重写规则说明：**
aof默认就是文件的无限追加，文件会越来越大!
如果aof文件大于64m，太大了，会fork一个新的进程来将文件重写！
 
优点：
1. 每一次修改都同步，文件的完整性会更加好！
2. 每秒同步一次，可能会丢失一秒的数据
3. 从不同步，效率最高

缺点：
1. 相对于数据文件来说，aof远远大于rdb，修复的速度也比rdb慢
2. Aof运行效率比rdb慢，所以redis默认的配置就是rdb持久化








