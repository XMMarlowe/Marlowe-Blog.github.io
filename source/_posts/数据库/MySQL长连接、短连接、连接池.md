---
title: MySQL长连接、短连接、连接池
author: Marlowe
tags:
  - MySQL
  - 连接池
categories: 数据库
abbrlink: 22796
date: 2021-05-21 21:40:42
---

<!--more-->

### 什么是短连接？

短连接是指程序和数据库通信时需要建立连接，执行操作后，连接关闭。短连接简单来说就是每一次操作数据库，都要打开和关闭数据库连接，基本步骤是：**连接 →数据传输 →关闭连接。**

### 什么是长连接？

长连接是指程序之间的连接在建立之后，就一直打开，被后续程序重用。使用长连接的初衷是减少连接的开销，尽管MySQL的连接比其他数据库要快得多。

以PHP程序为例，当收到一个永久连接的请求时，PHP将检查是否已经存在一个（前面已经开启了的）相同的永久连接。如果存在，则将直接使用这个连接；如果不存在，则建立一个新的连接。所谓“相同”的连接是指用相同的用户名和密码到相同主机的连接。

从客户端的角度来说，使用长连接有一个好处，可以不用每次创建新连接，若客户端对MySQL服务器的连接请求很频繁，永久连接将更加高效。对于高并发业务，如果可能会碰到连接的冲击，推荐使用长连接或连接池。

从服务器的角度来看，情况则略有不同，它可以节省创建连接的开销，但维持连接也是需要内存的。如果滥用长连接的话，可能会使用过多的MySQL服务器连接。现代的操作系统可以拥有几千个MySQL连接，但很有可能绝大部分都是睡眠（sleep）状态的，这样的工作方式不够高效，而且连接占据内存，也会导致内存的浪费。

对于扩展性好的站点来说，其实大部分的访问并不需要连接数据库。如果用户需要频繁访问数据库，那么可能会在流量增大的时候产生性能问题，此时长短连接都是无法解决问题的，所以应该进行合理的设计和优化来避免性能问题。

如果客户端和MySQL数据库之间有连接池或Proxy代理，一般在客户端推荐使用短连接。对于长连接的使用一定要慎重，不可滥用。如果没有每秒几百、上千的新连接请求，就不一定需要长连接，也无法从长连接中得到太多好处。在Java语言中，由于有连接池，如果控制得当，则不会对数据库有较大的冲击，但PHP的长连接可能导致数据库的连接数超过限制，或者占用过多的内存。

对此，研发工程师、系统运维工程师、DBA需要保持沟通，确定合理的连接策略，**千万不要不假思索就采用长连接。**

#### 注意

全部使用长连接后，你可能会发现，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。**怎么解决这个问题呢？**

#### 解决方案

1. 定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。

2. 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

#### 总结

长连接主要用于在少数客户端与服务端的频繁通信，因为这时候如果用短连接频繁通信常会发生Socket出错，并且频繁创建Socket连接也是对资源的浪费。

但是对于服务端来说，长连接也会耗费一定的资源，需要专门的线程（unix下可以用进程管理）来负责维护连接状态。

总之，长连接和短连接的选择要视情况而定。

**1、在频繁的与数据库服务通信，并且又非高并发的情况下，使用长连接更合适；**
**2、太多持久连接，大部分是sleep状态的，或者系统是高并发的，使用短连接更合适。**

### 连接池主要的作用

1、减少与数据服务器建立TCP连接三次握手及连接关闭四次挥手的开销，从而降低客户端和mysql服务端的负载，缩短请求响应时间。

2、减少数据库的并发连接数，即解决应用服务器过多导致的数据库 too many connections 问题。

### 如果是为了解决问题1

则在workerman中数据库连接池不是最高效的方法，反而是自找麻烦的做法。由于PHP是单进程单线程的，使用PHP实现数据库连接池，肯定需要用单独的进程去做，那么就会涉及到进程间的通讯，使得原本和mysql直接通讯的过程变成 与连接池再到mysql的通讯，增加了应用端的负载。

解决问题1最高效的方法是为每个业务进程建立一个数据库单例（例如workerman提供的DB类），实现数据库长连接，这样每个进程的所有请求都使用自己的这一个数据库长连接，整个进程的生命周期只有一次TCP握手和断开连接挥手的开销，并且应用与mysql直接通讯，没有连接池那样中间一层进程间IPC通讯，性能是最高的，没有之一。

### 如果是为了问题2

 首先看下自己到底有多少台应用服务器，每台服务器与mysql有多收并发连接。假如你只有10台应用服务器，每个服务器50个进程，每个进程1个数据库连接，那么到mysql服务端总共只有10*50=500个并发连接（并非活跃连接），500个并发连接对于mysql来说就是小菜一碟，为了解决问题2完全没有使用连接池的必要。

假如你有1000台应用服务器，那么连接池是有必要的，但是这个连接池不能是运行在本地应用服务器上的连接池，因为1000台应用服务器就有1000个连接池，即使每个连接池只开10个连接，那么数据库的连接数也会轻松打满。所以不要指望在当前服务器上开几个task进程实现的连接池就能解决这个问题。

1000台应用服务器的集群，每台服务器上搞几个进程实现连接池同样是不靠谱的方法。真正能够解决问题2的方法是建立一个独立的数据库连接池服务器或者说集群，全局管理所有的数据库链接。


### 参考

[Mysql 的 长连接？ 短连接？](https://my.oschina.net/u/4283151/blog/4122997)
[一篇读懂mysql长链接、短连接、连接池](https://www.jianshu.com/p/bd0903d350e8)
