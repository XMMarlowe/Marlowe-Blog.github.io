---
title: SQL执行过慢，如何排查以及调优
author: Marlowe
date: 2021-04-29 21:37:24
tags: 
  - SQL
  - 调优
categories: 数据库 
---

<!--more-->

### 导致SQL执行慢的原因

1. **硬件问题**。如网络速度慢，内存不足，I/O吞吐量小，磁盘空间满了等。

2. **没有索引或者索引失效**。（一般在互联网公司，DBA会在半夜把表锁了，重新建立一遍索引，因为当你删除某个数据的时候，索引的树结构就不完整了。所以互联网公司的数据做的是假删除，一是为了做数据分析,二是为了不破坏索引 ）

3. **数据过多**（分库分表）

4. **服务器调优及各个参数设置**（调整my.cnf）

5. 查询出的数据量过大（可以采用多次查询，其他的方法降低数据量）

6. 锁或者死锁(这也是查询慢最常见的问题，是程序设计的缺陷)

7. sp_lock,sp_who,活动的用户查看,原因是读写竞争资源。

8. 返回了不必要的行和列


### 分析原因时，一定要找切入点
1. 先观察，开启慢查询日志，设置相应的阈值（比如超过3秒就是慢SQL），在生产环境跑上个一天过后，看看哪些SQL比较慢。

2. Explain和慢SQL分析。比如SQL语句写的烂，索引没有或失效，关联查询太多（有时候是设计缺陷或者不得以的需求）等等。

3. Show Profile是比Explain更近一步的执行细节，可以查询到执行每一个SQL都干了什么事，这些事分别花了多少秒。

4. 找DBA或者运维对MySQL进行服务器的参数调优。

解析：

**(1)、explain出来的各种item的意义**

**id:** 每个被独立执行的操作的标志，表示对象被操作的顺序。一般来说， id 值大，先被执行；如果 id 值相同，则顺序从上到下。
**select_type：** 查询中每个 select 子句的类型。
**table:** 名字，被操作的对象名称，通常的表名(或者别名)，但是也有其他格式。
**partitions:** 匹配的分区信息。
**type:** join 类型。
**possible_keys：** 列出可能会用到的索引。
**key:** 实际用到的索引。
**key_len:** 用到的索引键的平均长度，单位为字节。
**ref:** 表示本行被操作的对象的参照对象，可能是一个常量用 const 表示，也可能是其他表的
key 指向的对象，比如说驱动表的连接列。
**rows:** 估计每次需要扫描的行数。
**filtered:** rows*filtered/100 表示该步骤最后得到的行数(估计值)。
**extra:** 重要的补充信息。

**(2)、profile的意义以及使用场景**

Profile 用来分析 sql 性能的消耗分布情况。当用 explain 无法解决慢 SQL 的时候，需要用profile 来对 sql 进行更细致的分析，找出 sql 所花的时间大部分消耗在哪个部分，确认 sql的性能瓶颈。

**(3)、explain 中的索引问题**

Explain 结果中，一般来说，要看到尽量用 index(type 为 const、 ref 等， key 列有值)，避免使用全表扫描(type 显式为 ALL)。比如说有 where 条件且选择性不错的列，需要建立索引。
被驱动表的连接列，也需要建立索引。被驱动表的连接列也可能会跟 where 条件列一起建立联合索引。当有排序或者 group by 的需求时，也可以考虑建立索引来达到直接排序和汇总的需求。


### 如何优化

1. 查看sql是否涉及多表的联表或者子查询，如果有，看是否能进行业务拆分，相关字段冗余或者合并成临时表（业务和算法的优化）

2. 涉及链表的查询，是否能进行分表查询，单表查询之后的结果进行字段整合

3. 如果以上两种都不能操作，非要链表查询，那么考虑对相对应的查询条件做索引。加快查询速度

4. 针对数量大的表进行历史表分离（如交易流水表）

5. 数据库主从分离，读写分离，降低读写针对同一表同时的压力，至于主从同步，mysql有自带的binlog实现 主从同步

6. explain分析sql语句，查看执行计划，分析索引是否用上，分析扫描行数等等

7. 查看mysql执行日志，看看是否有其他方面的问题


### 总结

从根本上来说，查询慢是占用sql内存比较多，那么可以从这方面去酌手考虑。


### 参考

[sql执行慢的原因有哪些，如何进行sql优化？](https://blog.csdn.net/zfx2013/article/details/90736670)


[SQL优化 | sql执行过长的时间，如何优化?](https://www.cnblogs.com/wyf0518/p/11461830.html)
